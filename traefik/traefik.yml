#cloud-config
users:
- name: traefik
  system: true
  shell: /usr/sbin/nologin

write_files:
- path: /etc/traefik/config.yaml
  owner: 'root:root'
  permissions: '0644'
  content: |
    ---
    # Generated by Cloud-init
    
    #------------------------------------------------------------------------------
    # GLOBAL
    #------------------------------------------------------------------------------
    global:
      checkNewVersion: false
      sendAnonymousUsage: false

    #------------------------------------------------------------------------------
    # ENTRYPOINTS
    #------------------------------------------------------------------------------
    entryPoints:
      http:
        address: ":80"
      https:
        address: ":443"

    #------------------------------------------------------------------------------
    # PROVIDERS
    #------------------------------------------------------------------------------
    providers:
      file:
        directory: /etc/traefik/routes
        watch: true

    #------------------------------------------------------------------------------
    # OBSERVABILITY
    #------------------------------------------------------------------------------

    # - Logs -
    log:
      format: common
      level: INFO

    #------------------------------------------------------------------------------
    # API
    #------------------------------------------------------------------------------
    api:
      dashboard: true
      insecure: true
- path: /etc/systemd/system/traefik.service
  owner: 'root:root'
  permissions: '0644'
  content: |
    [Unit]
    Description=Traefik Edge Router
    Documentation=https://doc.traefik.io/traefik/
    After=network-online.target
    AssertPathExists=/etc/traefik/config.yaml
    AssertPathIsDirectory=/etc/traefik/routes
    AssertFileIsExecutable=/usr/local/bin/traefik

    [Service]
    Type=notify
    User=traefik
    Group=traefik
    ExecStart=/usr/local/bin/traefik --configFile=/etc/traefik/config.yaml
    Restart=on-failure
    RestartSec=5
    WatchdogSec=5
    AmbientCapabilities=CAP_NET_BIND_SERVICE
    CapabilityBoundingSet=CAP_NET_BIND_SERVICE
    NoNewPrivileges=true

    [Install]
    WantedBy=multi-user.target

runcmd:
- wget -P /tmp https://github.com/traefik/traefik/releases/download/v2.9.6/traefik_v2.9.6_linux_amd64.tar.gz
- tar -xvzf /tmp/traefik_v2.9.6_linux_amd64.tar.gz -C /usr/local/bin traefik
- chown root:root /usr/local/bin/traefik
- rm -rf /tmp/traefik_v2.9.6_linux_amd64.tar.gz
- mkdir -p /etc/traefik /etc/traefik/routes
- systemctl daemon-reload
- systemctl enable --now traefik.service
